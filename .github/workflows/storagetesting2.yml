name: full end to end storage teting 

on:
  workflow_dispatch:
  # pull_request:
  #   types: [opened, synchronize, reopened, closed]
  # push:
  #   branches:
  #    - master
  #    - develop
  #    - release

env:
  # AZURE_WEBAPP_NAME: "app-munson-api-eastus-dev-001"
  ArtifactName: "TEST"

permissions:
  contents: read
  pages: write
  id-token: write
  
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
        
      - name: Restore dependencies
        run: dotnet restore CircleApp.sln

      - name: Build
        run: dotnet build CircleApp/CircleApp.csproj --configuration Release --no-restore
        
      - name: Publish project
        run: dotnet publish CircleApp/CircleApp.csproj --configuration Release --output ./publish

      - name: Create deployment zip
        run: |
          cd ./publish
          zip -r ../CircleApp.zip .
          cd ..
      # - name: Zip Publish Artifact
      #   run: |
      #     mkdir -p ${{ github.workspace }}/CircleApp/Publish
      #     cd ${{ github.workspace }}/temp/publish
      #     zip -r ${{ github.workspace }}/CircleApp/Publish/publish.zip .
      #     # zip -r ../myapp.zip .
          
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: CircleAppPackage
          path: CircleApp.zip

  deployOnDev:
    runs-on: runner1
    needs: build
    # if: github.base_ref == 'master'
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
          name: CircleAppPackage
          path: CircleAppPackage

    - name: Install Azure CLI
      run: |
        curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
        
    - name: Login to Azure Subscription
      uses: azure/login@v1
      with:
       client-id: ${{ secrets.DEV_AZURE_CLIENT_ID }}
       tenant-id: ${{ secrets.AZURE_TENANT_ID }}
       allow-no-subscriptions: true

      # 3. Upload artifact to Azure Storage so the VM can fetch it

      # 3. Upload artifact to Azure Storage so the VM can fetch it
    - name: Upload to Azure Storage
      run: |
          az storage blob upload \
            --account-name testvmgroupb7e2  \
            --container-name artifacts \
            --file CircleAppPackage/CircleApp.zip \
            --name CircleApp_${{ github.run_id }}.zip \
            --overwrite
            
    - name: Deploy to IIS VM
      run: |
          az vm run-command invoke \
            --resource-group testvm_group \
            --name testvm \
            --command-id RunPowerShellScript \
            --scripts '
              param([string]$RunId)
          
              # Paths & Variables
              $storageAccount = "testvmgroupb7e2"
              $container = "artifacts"
              $blobName = "CircleApp_$RunId.zip"
              $destFile = "C:\temp\CircleApp_$RunId.zip"
              $sitePath = "C:\inetpub\wwwroot\CircleApp"
              $backupPath = "C:\inetpub\wwwroot\Backup\CircleApp_$((Get-Date -Format 'yyyyMMdd_HHmmss'))"
              $logFile = "C:\temp\deploy_log_$RunId.txt"
          
              # Enable logging
              Write-Output "=== Deployment Started: $RunId ===" | Tee-Object $logFile -Append
          
              Write-Output "Authenticating using Managed Identity..." | Tee-Object $logFile -Append
              az login --identity | Out-Null
          
              # 1️⃣ Backup Existing Site
              if (Test-Path $sitePath) {
                  Write-Output "Backing up current site to $backupPath" | Tee-Object $logFile -Append
                  New-Item -ItemType Directory -Path $backupPath -Force | Out-Null
                  Copy-Item -Recurse -Force $sitePath\* $backupPath | Tee-Object $logFile -Append
              } else {
                  Write-Output "Site path not found, skipping backup." | Tee-Object $logFile -Append
              }
          
              # 2️⃣ Download Artifact
              Write-Output "Downloading build artifact $blobName..." | Tee-Object $logFile -Append
              az storage blob download `
                --account-name $storageAccount `
                --container-name $container `
                --name $blobName `
                --file $destFile `
                --auth-mode login `
                --overwrite | Tee-Object $logFile -Append
          
              Write-Output "Download Completed!" | Tee-Object $logFile -Append
          
              # 3️⃣ Stop IIS Gracefully
              Import-Module WebAdministration
              Write-Output "Stopping site & app pool..." | Tee-Object $logFile -Append
              Stop-WebAppPool "DefaultAppPool"
              Stop-Website "Default Web Site"
          
              # Replace Files
              Write-Output "Replacing site files..." | Tee-Object $logFile -Append
              if (Test-Path $sitePath) { Remove-Item -Recurse -Force $sitePath }
              Expand-Archive -Path $destFile -DestinationPath $sitePath -Force | Tee-Object $logFile -Append
          
              # 4️⃣ Start IIS
              Write-Output "Starting site & app pool..." | Tee-Object $logFile -Append
              Start-WebAppPool "DefaultAppPool"
              Start-Website "Default Web Site"
          
              Write-Output "Deployment completed successfully!" | Tee-Object $logFile -Append
          
              # 5️⃣ Upload Deployment Log to Blob Storage
              Write-Output "Uploading log to blob storage..." | Tee-Object $logFile -Append
              $logBlobName = "logs/deploy_log_$RunId.txt"
              az storage blob upload `
                --account-name $storageAccount `
                --container-name $container `
                --name $logBlobName `
                --file $logFile `
                --auth-mode login `
                --overwrite | Tee-Object $logFile -Append
          
              Write-Output "=== Deployment Finished ===" | Tee-Object $logFile -Append
              Write-Output "Deleting deployment artifact from Blob Storage..." | Tee-Object $logFile -Append
              
            # 5️⃣ Delete Zip File from Blob Storage
            az storage blob delete `
                --account-name $storageAccount `
                --container-name $container `
                --name $blobName `
                --auth-mode login | Tee-Object $logFile -Append

            Write-Output "Artifact deleted successfully!" | Tee-Object $logFile -Append
            ' \
            --parameters "RunId=${{ github.run_id }}"
            
    # - name: Install PowerShell
    #   run: |
    #     # Update package list
    #     sudo apt-get update
        
    #     # Install pre-requisites
    #     sudo apt-get install -y wget apt-transport-https software-properties-common
        
    #     # Download Microsoft repository GPG keys
    #     wget -q "https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb" -O packages-microsoft-prod.deb
        
    #     # Register Microsoft repository
    #     sudo dpkg -i packages-microsoft-prod.deb
        
    #     # Update after adding repo
    #     sudo apt-get update
        
    #     # Install PowerShell
    #     sudo apt-get install -y powershell
        
    #     # Start PowerShell
    #     pwsh

    # - name: Deploy to IIS VM
    #   run: |
    #     az vm run-command invoke \
    #       --resource-group testvm_group \
    #       --name testvm \
    #       --command-id RunPowerShellScript \
    #       --scripts "@scripts/deploy.ps1" \
    #       --parameters "RunId=${{ github.run_id }}"

        
    # - name: Deploy to IIS via SSH
    #   run: |
    #     sudo apt-get update
    #     sudo apt-get install -y sshpass
    
    #     pwsh -Command "
    #       sshpass -p '${{ secrets.WINRM_PASSWORD }}' \
    #       ssh -o StrictHostKeyChecking=no ${{ secrets.WINRM_USER }}@${{ secrets.WINRM_HOST }} `
    #         'powershell -File C:\deploy\deploy.ps1'"
    #   shell: bash
            
    # - name: Deploy to IIS Server via WinRM
    #   shell: pwsh
    #   run: |
    #         $user = "${{ secrets.WINRM_USERNAME }}"
    #         $pass = ConvertTo-SecureString "${{ secrets.WINRM_PASSWORD }}" -AsPlainText -Force
    #         $cred = New-Object System.Management.Automation.PSCredential ($user, $pass)

    #         Invoke-Command -ComputerName ${{ secrets.WINRM_HOST }} -Credential $cred -ScriptBlock {
              
    #           $artifactUrl = "${{ secrets.AZURE_STORAGE_SAS_URL }}"
    #           $downloadPath = "C:\temp\CircleApp_${{ github.run_id }}.zip"
    #           $webRoot = "C:\inetpub\wwwroot"

    #           Write-Host "Downloading artifact from Azure Storage..."
    #           azcopy copy $artifactUrl $downloadPath --overwrite=true

    #           Write-Host "Extracting to IIS folder..."
    #           Expand-Archive -LiteralPath $downloadPath -DestinationPath $webRoot -Force

    #           Write-Host "Restarting IIS..."
    #           iisreset
    #         }
